name: CI — Integration Tests (Graph API)

# Runs integration tests against a live Entra ID / Intune tenant.
# Requires a GitHub Environment named "integration-test" with these secrets:
#   AZURE_TENANT_ID     — Entra ID tenant for the test app registration
#   AZURE_CLIENT_ID     — App registration client ID
#   AZURE_CLIENT_SECRET — App registration client secret
#
# Setup: GitHub -> Settings -> Environments -> New environment -> "integration-test"
#   Then add the three secrets above under that environment.
#   Optionally add required reviewers or branch restrictions.
#
# Required Graph API permissions (Application):
#   DeviceManagementConfiguration.ReadWrite.All
#   DeviceManagementApps.ReadWrite.All
#   DeviceManagementManagedDevices.ReadWrite.All
#   DeviceManagementRBAC.ReadWrite.All
#   DeviceManagementServiceConfig.ReadWrite.All
#   DeviceManagementScripts.ReadWrite.All
#   Policy.ReadWrite.ConditionalAccess
#   Policy.Read.All
#   Agreement.ReadWrite.All
#   Group.Read.All

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggers

jobs:
  integration:
    runs-on: ubuntu-latest
    environment: integration-test
    # Only run if not a fork PR (forks won't have access to the environment)
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: read

    env:
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets
        id: check-secrets
        shell: bash
        run: |
          if [ -z "$AZURE_TENANT_ID" ] || [ -z "$AZURE_CLIENT_ID" ] || [ -z "$AZURE_CLIENT_SECRET" ]; then
            echo "has_secrets=false" >> "$GITHUB_OUTPUT"
            echo "WARNING: Azure credentials not configured in the 'integration-test' environment -- skipping"
          else
            echo "has_secrets=true" >> "$GITHUB_OUTPUT"
            echo "Azure credentials found in 'integration-test' environment"
          fi

      - name: Setup .NET 10
        if: steps.check-secrets.outputs.has_secrets == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore dependencies
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: dotnet restore Intune.Commander.sln

      - name: Build solution
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: dotnet build Intune.Commander.sln --configuration Release --no-restore

      - name: Run integration tests
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          dotnet test Intune.Commander.sln \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --filter "Category=Integration" \
            --logger "trx;LogFileName=integration-results.trx"
        timeout-minutes: 15

      - name: Upload test results
        if: always() && steps.check-secrets.outputs.has_secrets == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: tests/**/TestResults/*.trx
          retention-days: 14

      - name: Cleanup stale test resources
        if: failure() && steps.check-secrets.outputs.has_secrets == 'true'
        shell: bash
        run: |
          echo "WARNING: Integration tests failed -- check for orphaned resources with prefix 'IntTest_AutoCleanup_' in your Intune tenant"
