<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Intune.Commander.Desktop.ViewModels"
        xmlns:models="using:Intune.Commander.Desktop.Models"
        xmlns:conv="using:Intune.Commander.Desktop.Converters"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="600"
        x:Class="Intune.Commander.Desktop.Views.DebugLogWindow"
        x:DataType="vm:DebugLogViewModel"
        Title="Intune Commander — Debug Log"
        Width="1200" Height="900"
        MinWidth="1200" MinHeight="900">

    <Design.DataContext>
        <vm:DebugLogViewModel />
    </Design.DataContext>

    <DockPanel>
        <!-- Toolbar row 1: search + category + action buttons -->
        <Border DockPanel.Dock="Top"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="8,5">
            <DockPanel>
                <!-- Buttons on the right must be declared before the fill child -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="6">
                    <Button x:Name="CopySelectedButton" Content="Copy Selected" Click="OnCopySelected" Padding="10,3" FontSize="12" />
                    <Button x:Name="CopyAllButton"      Content="Copy All"      Click="OnCopyAll"      Padding="10,3" FontSize="12" />
                    <Button Content="Export..."     Click="OnSaveLog"      Padding="10,3" FontSize="12" />
                    <Button Content="Clear" Command="{Binding ClearLogCommand}" Padding="10,3" FontSize="12" />
                </StackPanel>
                <!-- Search + category filter fill remaining space -->
                <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <TextBlock Text="Debug Log" FontSize="13" FontWeight="SemiBold" VerticalAlignment="Center" />
                    <TextBox Width="200" Watermark="Search..."
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" />
                    <ComboBox Width="130"
                              ItemsSource="{Binding Categories}"
                              SelectedItem="{Binding SelectedCategory}" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Toolbar row 2: level toggles + auto-scroll -->
        <Border DockPanel.Dock="Top"
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                BorderBrush="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                BorderThickness="0,1,0,0"
                Padding="8,4">
            <StackPanel Orientation="Horizontal" Spacing="9">
                <TextBlock Text="Show:" VerticalAlignment="Center" FontSize="12" />
                <CheckBox Content="Debug"  IsChecked="{Binding ShowDebug}"   FontSize="12" />
                <CheckBox Content="Info"   IsChecked="{Binding ShowInfo}"    FontSize="12" />
                <CheckBox Content="Warn"   IsChecked="{Binding ShowWarning}" FontSize="12" />
                <CheckBox Content="Error"  IsChecked="{Binding ShowError}"   FontSize="12" />
                <ToggleSwitch Content="Auto-scroll" IsChecked="{Binding AutoScroll}"
                              FontSize="12" Margin="16,0,0,0" />
            </StackPanel>
        </Border>

        <!-- Two-pane content: flat log (top ~60%) + grouped modules (bottom ~40%) -->
        <Grid RowDefinitions="3*,4,2*">

            <!-- ── Row 0: flat streaming log ─────────────────────────────── -->
            <ListBox Grid.Row="0"
                     ItemsSource="{Binding FilteredEntries}"
                     x:Name="LogListBox"
                     Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                     Padding="4"
                     SelectionMode="Multiple"
                     ScrollViewer.HorizontalScrollBarVisibility="Auto"
                     ScrollViewer.VerticalScrollBarVisibility="Auto"
                     Margin="0">
                <ListBox.ItemTemplate>
                    <DataTemplate x:DataType="models:DebugLogEntry">
                        <Border Padding="2,1">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss.fff}'}"
                                           FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                           FontSize="12" VerticalAlignment="Center" />
                                <!-- Category badge -->
                                <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                        CornerRadius="3" Padding="4,1">
                                    <TextBlock Text="{Binding Category}" FontSize="11" VerticalAlignment="Center" />
                                </Border>
                                <!-- Level badge (colored) -->
                                <Border Background="{Binding Level, Converter={x:Static conv:DebugLevelBrushConverter.Instance}}"
                                        CornerRadius="3" Padding="4,1">
                                    <TextBlock Text="{Binding Level}" FontSize="11" Foreground="White"
                                               FontWeight="SemiBold" VerticalAlignment="Center" />
                                </Border>
                                <SelectableTextBlock Text="{Binding Message}"
                                           FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                           FontSize="12" TextWrapping="NoWrap"
                                           VerticalAlignment="Center" />
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <!-- ── Row 1: splitter ───────────────────────────────────────── -->
            <GridSplitter Grid.Row="1" Height="4" HorizontalAlignment="Stretch"
                          Background="{DynamicResource SystemControlBackgroundBaseLowBrush}" />

            <!-- ── Row 2: grouped modules panel ─────────────────────────── -->
            <ScrollViewer Grid.Row="2"
                          VerticalScrollBarVisibility="Visible"
                          HorizontalScrollBarVisibility="Disabled"
                          Background="{DynamicResource SystemControlBackgroundAltHighBrush}">
                <ScrollViewer.Styles>
                    <Style Selector="ScrollBar:vertical">
                        <Setter Property="Width" Value="20" />
                    </Style>
                </ScrollViewer.Styles>
                <StackPanel Margin="6,4">
                    <TextBlock Text="Modules" FontWeight="SemiBold" FontSize="12" Margin="0,0,0,4" />
                    <ItemsControl ItemsSource="{Binding GroupedEntries}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:DebugLogGroup">
                                <Expander Header="{Binding Category}" IsExpanded="True" Margin="0,2">
                                    <ItemsControl ItemsSource="{Binding Entries}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate x:DataType="models:DebugLogEntry">
                                                <SelectableTextBlock Text="{Binding Formatted}"
                                                            FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                                            FontSize="12"
                                                            Padding="4,1"
                                                            TextWrapping="NoWrap" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Expander>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>

        </Grid>
    </DockPanel>
</Window>
