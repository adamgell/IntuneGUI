<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:IntuneManager.Desktop.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="700" d:DesignHeight="500"
        x:Class="IntuneManager.Desktop.Views.DebugLogWindow"
        x:DataType="vm:DebugLogViewModel"
        Title="Intune Commander â€” Debug Log"
        Width="800" Height="500"
        MinWidth="400" MinHeight="250">

    <Design.DataContext>
        <vm:DebugLogViewModel />
    </Design.DataContext>

    <DockPanel>
        <!-- Toolbar -->
        <Border DockPanel.Dock="Top" Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="8,6">
            <DockPanel>
                <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                    <TextBlock Text="Debug Log" FontSize="14" FontWeight="SemiBold" />
                    <TextBox Width="200" Watermark="Search..."
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" />
                    <ComboBox Width="140"
                              ItemsSource="{Binding Categories}"
                              SelectedItem="{Binding SelectedCategory}" />
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <CheckBox Content="Debug" IsChecked="{Binding ShowDebug}" />
                        <CheckBox Content="Info" IsChecked="{Binding ShowInfo}" />
                        <CheckBox Content="Warn" IsChecked="{Binding ShowWarning}" />
                        <CheckBox Content="Error" IsChecked="{Binding ShowError}" />
                        <ToggleSwitch Content="Auto-scroll" IsChecked="{Binding AutoScroll}" />
                    </StackPanel>
                </StackPanel>
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="8"
                            HorizontalAlignment="Right">
                    <Button Content="Copy Selected" Click="OnCopySelected"
                            Padding="12,4" FontSize="12" />
                    <Button Content="Copy All" Click="OnCopyAll"
                            Padding="12,4" FontSize="12" />
                    <Button Content="Export..." Click="OnSaveLog"
                            Padding="12,4" FontSize="12" />
                    <Button Content="Clear" Command="{Binding ClearLogCommand}"
                            Padding="12,4" FontSize="12" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Log entries -->
        <Grid RowDefinitions="*,Auto" ColumnDefinitions="2* , *" Margin="6">
            <ListBox Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                     ItemsSource="{Binding FilteredEntries}"
                     x:Name="LogListBox"
                     Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                     Padding="4"
                     SelectionMode="Multiple"
                     ScrollViewer.HorizontalScrollBarVisibility="Auto">
                <ListBox.ItemTemplate>
                    <DataTemplate>
                        <Border Padding="4,2">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss.fff}'}"
                                           FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                           FontSize="12" />
                                <Border Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}"
                                        CornerRadius="4" Padding="4,1">
                                    <TextBlock Text="{Binding Category}" FontSize="11" />
                                </Border>
                                <TextBlock Text="{Binding Level}"
                                           FontSize="11" FontWeight="SemiBold" />
                                <SelectableTextBlock Text="{Binding Message}"
                                           FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                           FontSize="12"
                                           TextWrapping="NoWrap" />
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

            <ScrollViewer Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                          VerticalScrollBarVisibility="Auto" Margin="0,8,0,0">
                <StackPanel Spacing="6">
                    <TextBlock Text="Modules" FontWeight="SemiBold" />
                    <ItemsControl ItemsSource="{Binding GroupedEntries}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Expander Header="{Binding Category}" IsExpanded="True">
                                    <ItemsControl ItemsSource="{Binding Entries}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <SelectableTextBlock Text="{Binding Formatted}"
                                                            FontFamily="Cascadia Code, Consolas, Courier New, monospace"
                                                            FontSize="12"
                                                            Padding="4,1" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </Expander>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </ScrollViewer>
        </Grid>
    </DockPanel>
</Window>
